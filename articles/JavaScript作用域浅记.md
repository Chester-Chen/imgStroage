date: 2020.05.12

## 1、作用域链

执行环境(execution context即'环境')定义了变量或函数有权访问的其他数据，决定了它们各自的行为。每个执行环境都有一个与之关联的变量环境，环境中定义的所有变量和函数都保存在这个对象中。虽然我们无法访问该对象，但是解析器在处理数据时会在后台使用它。

全局执行环境是最外围的一个执行环境。根据宿主环境的不同，表示执行环境的对象也不一样。在web浏览器中，全局执行环境被认为是window对象，因此所有全局变量和函数都是作为window对象的属性和方法创建的。

当代码在一个环境中执行时，会创建变量对象的一个**作用域链**。作用域链是为了保证对执行环境有权访问的所有变量和函数的有序访问。作用域链的前端，始终都是当前执行的代码所在环境的变量对象。如果这个环境是函数，则将其活动对象作为变量对象。活动对象最开始只有一个变量，那就是arguments对象(这个对象在全局环境中是不存在的)。作用域链中的下一个变量对象来自于它的包含环境，而再下一个变量对象则来自下一个包含环境。这样一直延续到全局执行环境。全局执行环境的变量对象始终都是作用域链中的最后一个对象。

上面的描述可能比较长，简单来说，作用域链就是像剥洋葱一样，最里层的变量能访问外层环境的变量，而外层的环境不能访问里层的变量。下面举个例子。

```javaScript
var color = 'blue';

function changeColor() {

    var anotherColor = 'red';
    function swapColor() {
        var tempColor = anotherColor;
        anotherColor = color;
        color = tempColor;

        // 在swapColor（）执行环境里能访问到color、anotherColor、tempColor
    }
        // 在这里能访问到color、anotherColor
}

// 在最外头，即全局环境下只能访问到color
changeColor();
```
```
用这个图来展示上面例子的作用域链

window 
    |
    |----color
    |
    |----changeColor()
              |
              |----anotherColor
              |
              |----swapColor()
                        |
                        |----tempColor
```

用书上的说法就是，内部环境可以通过作用域链访问所有的外部环境，但外部环境不能访问内部环境中的任何变量和函数。这些环境之间的联系是线性、有次序的。每个环境都可以向上搜索作用域链，以查询变量和函数名；但任何环境都不能向下搜索作用域链而进入另一个执行环境。

例如在，swapColor()中，访问变量color，在swapColor()局部环境中搜索不到该变量，就向上一级作用域链搜索。

## 2、延长作用域链
执行环境总共只有2种：全局和局部。有些语句可以在作用域链的前端临时增加一个变量对象，该变量对象会在代码执行后被移除。就是当执行流进入下列任何一个语句是，作用域链就会得到加长。
- try-catch语句的catch块
- with语句
```javaScript

function test() {

    var para = 'abc';
    with(location) {

        var url = href + para;
    }
    return url;
}

```

上面的代码块中，with语句接受的是location对象，这个变量对象被添加到了作用域链的前端。当在引用变量href时(实际上时引用的location.href)，可以在当前执行环境的变量对象中找到。